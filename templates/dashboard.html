<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据仪表盘 - 抖音数据分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
        }

        .header a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: all 0.3s;
        }

        .header a:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: #667eea;
            color: white;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            color: #667eea;
            font-size: 32px;
            font-weight: bold;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>数据仪表盘</h1>
        <a href="/">返回首页</a>
    </div>

    <div class="container">
        <div class="action-bar">
            <button class="btn" onclick="loadAllCharts()">刷新数据</button>
            <button class="btn btn-success" onclick="analyzeSentiment()">情感分析</button>
            <button class="btn btn-warning" onclick="trainModel()">训练预测模型</button>
        </div>

        <div id="loading" class="loading">
            <p>加载中...</p>
        </div>

        <div id="message" class="message"></div>

        <div class="stats-cards">
            <div class="stat-card">
                <h3>总用户数</h3>
                <div class="number" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <h3>总视频数</h3>
                <div class="number" id="totalVideos">0</div>
            </div>
            <div class="stat-card">
                <h3>总评论数</h3>
                <div class="number" id="totalComments">0</div>
            </div>
            <div class="stat-card">
                <h3>认证用户</h3>
                <div class="number" id="verifiedUsers">0</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>用户IP分布</h3>
                <div id="ipChart" class="chart-container"></div>
            </div>

            <div class="chart-card">
                <h3>粉丝数量区间分布</h3>
                <div id="followersChart" class="chart-container"></div>
            </div>

            <div class="chart-card">
                <h3>点赞与收藏关系</h3>
                <div id="likeCollectChart" class="chart-container"></div>
            </div>

            <div class="chart-card">
                <h3>发布时间分布</h3>
                <div id="timeChart" class="chart-container"></div>
            </div>

            <div class="chart-card full-width">
                <h3>Top 10 粉丝用户</h3>
                <div id="topUsersChart" class="chart-container"></div>
            </div>

            <div class="chart-card full-width">
                <h3>评论情感分布</h3>
                <div id="sentimentChart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时加载所有图表
        window.onload = function() {
            loadAllCharts();
        };

        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('message').style.display = 'none';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // 显示消息
        function showMessage(message, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + (isError ? 'error' : 'success');
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // 加载所有图表
        function loadAllCharts() {
            showLoading();
            Promise.all([
                loadStats(),
                loadIpChart(),
                loadFollowersChart(),
                loadLikeCollectChart(),
                loadTimeChart(),
                loadTopUsersChart(),
                loadSentimentChart()
            ]).then(() => {
                hideLoading();
            }).catch(error => {
                hideLoading();
                showMessage('加载失败：' + error, true);
            });
        }

        // 加载统计数据
        function loadStats() {
            return fetch('/api/general-stats/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalUsers').textContent = data.data.total_users;
                        document.getElementById('totalVideos').textContent = data.data.total_videos;
                        document.getElementById('totalComments').textContent = data.data.total_comments;
                        document.getElementById('verifiedUsers').textContent = data.data.verified_users;
                    }
                });
        }

        // 加载IP分布图表
        function loadIpChart() {
            return fetch('/api/ip-distribution/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const chart = echarts.init(document.getElementById('ipChart'));
                        chart.setOption({
                            tooltip: { trigger: 'item' },
                            legend: { top: '5%', left: 'center' },
                            series: [{
                                name: 'IP分布',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                itemStyle: {
                                    borderRadius: 10,
                                    borderColor: '#fff',
                                    borderWidth: 2
                                },
                                label: { show: false, position: 'center' },
                                emphasis: {
                                    label: { show: true, fontSize: 20, fontWeight: 'bold' }
                                },
                                data: Object.entries(data.data).map(([key, value]) => ({ name: key, value: value }))
                            }]
                        });
                    }
                });
        }

        // 加载粉丝分布图表
        function loadFollowersChart() {
            return fetch('/api/followers-distribution/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const chart = echarts.init(document.getElementById('followersChart'));
                        chart.setOption({
                            tooltip: { trigger: 'axis' },
                            xAxis: {
                                type: 'category',
                                data: Object.keys(data.data),
                                axisLabel: { rotate: 30 }
                            },
                            yAxis: { type: 'value' },
                            series: [{
                                name: '用户数',
                                type: 'bar',
                                data: Object.values(data.data),
                                itemStyle: { color: '#667eea' }
                            }]
                        });
                    }
                });
        }

        // 加载点赞收藏关系图表
        function loadLikeCollectChart() {
            return fetch('/api/like-collect-relation/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const chart = echarts.init(document.getElementById('likeCollectChart'));
                        const relation = data.data.like_collect_relation || {};
                        chart.setOption({
                            tooltip: { trigger: 'axis' },
                            xAxis: {
                                type: 'category',
                                data: Object.keys(relation),
                                axisLabel: { rotate: 30 }
                            },
                            yAxis: { type: 'value', name: '平均收藏数' },
                            series: [{
                                name: '平均收藏数',
                                type: 'line',
                                data: Object.values(relation),
                                smooth: true,
                                itemStyle: { color: '#28a745' },
                                areaStyle: { opacity: 0.3 }
                            }]
                        });
                    }
                });
        }

        // 加载发布时间分布图表
        function loadTimeChart() {
            return fetch('/api/publish-time-distribution/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const chart = echarts.init(document.getElementById('timeChart'));
                        const hours = Array.from({ length: 24 }, (_, i) => i + '时');
                        const values = hours.map(h => data.data[h] || 0);
                        chart.setOption({
                            tooltip: { trigger: 'axis' },
                            xAxis: { type: 'category', data: hours },
                            yAxis: { type: 'value' },
                            series: [{
                                name: '视频数',
                                type: 'bar',
                                data: values,
                                itemStyle: { color: '#ffc107' }
                            }]
                        });
                    }
                });
        }

        // 加载Top用户图表
        function loadTopUsersChart() {
            return fetch('/api/top-users/?limit=10')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const chart = echarts.init(document.getElementById('topUsersChart'));
                        const names = data.data.map(u => u.nickname);
                        const followers = data.data.map(u => u.followers);
                        chart.setOption({
                            tooltip: { trigger: 'axis' },
                            xAxis: {
                                type: 'category',
                                data: names,
                                axisLabel: { rotate: 45 }
                            },
                            yAxis: { type: 'value', name: '粉丝数' },
                            series: [{
                                name: '粉丝数',
                                type: 'bar',
                                data: followers,
                                itemStyle: { color: '#764ba2' }
                            }]
                        });
                    }
                });
        }

        // 加载情感分布图表
        function loadSentimentChart() {
            return fetch('/api/comment-sentiment/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.distribution) {
                        const chart = echarts.init(document.getElementById('sentimentChart'));
                        chart.setOption({
                            tooltip: { trigger: 'item' },
                            legend: { top: '5%', left: 'center' },
                            series: [{
                                name: '情感分布',
                                type: 'pie',
                                radius: '70%',
                                data: [
                                    { value: data.data.distribution.positive || 0, name: '积极', itemStyle: { color: '#28a745' } },
                                    { value: data.data.distribution.neutral || 0, name: '中性', itemStyle: { color: '#ffc107' } },
                                    { value: data.data.distribution.negative || 0, name: '消极', itemStyle: { color: '#dc3545' } }
                                ],
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }]
                        });
                    }
                });
        }

        // 情感分析
        function analyzeSentiment() {
            showLoading();
            fetch('/api/analyze-sentiment/', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showMessage('情感分析完成！');
                    loadSentimentChart();
                } else {
                    showMessage('分析失败：' + data.error, true);
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('请求失败：' + error, true);
            });
        }

        // 训练预测模型
        function trainModel() {
            showLoading();
            fetch('/api/train-predictor/', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showMessage('模型训练完成！R²=' + data.data.test_r2);
                } else {
                    showMessage('训练失败：' + data.error, true);
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('请求失败：' + error, true);
            });
        }

        // 响应式调整
        window.addEventListener('resize', function() {
            const charts = ['ipChart', 'followersChart', 'likeCollectChart', 'timeChart', 'topUsersChart', 'sentimentChart'];
            charts.forEach(id => {
                const chart = echarts.getInstanceByDom(document.getElementById(id));
                if (chart) chart.resize();
            });
        });
    </script>
</body>
</html>
